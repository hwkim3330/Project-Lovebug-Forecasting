<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lovebug Map - Advanced AI Dashboard</title>
    
    <!-- 지도 라이브러리 (Leaflet.js) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- 아이콘 라이브러리 (Font Awesome) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* 폰트 및 CSS 변수 (라이트/다크 모드용) */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap');
        
        :root {
            --bg-color: #f0f2f5;
            --sidebar-bg: #ffffff;
            --text-color: #333;
            --text-muted: #666;
            --header-color: #1a237e;
            --accent-color: #3f51b5;
            --border-color: #e0e0e0;
            --item-bg: #f9f9f9;
            --shadow-color: rgba(0,0,0,0.1);
        }

        [data-theme="dark"] {
            --bg-color: #121212;
            --sidebar-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --text-muted: #a0a0a0;
            --header-color: #bb86fc;
            --accent-color: #90caf9;
            --border-color: #333;
            --item-bg: #2c2c2c;
            --shadow-color: rgba(0,0,0,0.4);
        }
        
        body, html {
            margin: 0; padding: 0;
            width: 100%; height: 100%;
            font-family: 'Noto Sans KR', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow: hidden;
            display: flex;
            transition: background-color 0.3s, color 0.3s;
        }

        /* 레이아웃 */
        .container { display: flex; width: 100%; height: 100%; }
        .sidebar {
            width: 350px;
            background-color: var(--sidebar-bg);
            padding: 20px;
            box-shadow: 2px 0 5px var(--shadow-color);
            display: flex; flex-direction: column;
            z-index: 1000;
            overflow-y: auto;
            transition: background-color 0.3s;
        }
        .main-content { flex-grow: 1; position: relative; }
        #map { width: 100%; height: 100%; background-color: #ddd; }

        /* 헤더 및 정보 패널 */
        .header { text-align: center; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 20px; }
        .header h1 { font-size: 24px; color: var(--header-color); margin: 0; display: flex; align-items: center; justify-content: center; }
        .header h1 i { margin-right: 10px; color: #d32f2f; }
        .header p { font-size: 14px; color: var(--text-muted); margin: 5px 0 0; }

        .dashboard-info { font-size: 14px; color: var(--text-muted); background-color: var(--item-bg); padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid var(--border-color); }
        .info-item { display: flex; justify-content: space-between; margin-bottom: 8px; }
        .info-item span:first-child { font-weight: 500; }
        #current-time, #last-updated { font-weight: 700; color: var(--accent-color); }

        /* 핫스팟 목록 */
        .hotspot-list h2 { font-size: 18px; color: var(--text-color); margin-bottom: 15px; border-bottom: 2px solid var(--accent-color); padding-bottom: 5px; }
        .hotspot-item { background-color: var(--item-bg); border: 1px solid var(--border-color); border-left: 5px solid; padding: 12px; margin-bottom: 10px; border-radius: 5px; cursor: pointer; transition: all 0.2s ease-in-out; animation: fadeIn 0.5s ease-out forwards; }
        .hotspot-item:hover, .hotspot-item.highlight { transform: scale(1.03); box-shadow: 0 4px 12px var(--shadow-color); background-color: var(--accent-color); color: white; }
        .hotspot-item.highlight .item-header .name, .hotspot-item.highlight .item-details, .hotspot-item.highlight .risk-score { color: white !important; }

        .hotspot-item.danger { border-left-color: #e53935; } .hotspot-item.warning { border-left-color: #f57c00; } .hotspot-item.moderate { border-left-color: #fdd835; }
        .item-header { display: flex; justify-content: space-between; align-items: center; }
        .item-header .name { font-weight: 700; font-size: 16px; }
        .item-header .rank { background-color: #333; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 700; }
        .item-details { font-size: 13px; color: var(--text-muted); margin-top: 5px; }
        .risk-score { font-weight: 700; }
        .risk-score.danger { color: #e53935; } .risk-score.warning { color: #f57c00; } .risk-score.moderate { color: #b49300; }

        /* 지도 위 컨트롤 */
        .map-controls { position: absolute; top: 10px; right: 10px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .map-info-panel { background-color: var(--sidebar-bg); padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px var(--shadow-color); }
        .map-info-panel h3 { margin: 0 0 10px 0; font-size: 16px; }
        .legend { list-style: none; padding: 0; margin: 0; }
        .legend li { display: flex; align-items: center; margin-bottom: 5px; font-size: 14px; }
        .legend i { width: 18px; height: 18px; margin-right: 8px; border-radius: 3px; }

        /* 다크모드 토글 */
        .theme-switch-wrapper { display: flex; align-items: center; background: var(--item-bg); padding: 5px 10px; border-radius: 20px; border: 1px solid var(--border-color); }
        .theme-switch { display: inline-block; height: 24px; position: relative; width: 48px; }
        .theme-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--accent-color); }
        input:checked + .slider:before { transform: translateX(24px); }
        .theme-switch-wrapper i { margin-right: 8px; font-size: 14px; color: var(--text-muted); }

        /* 애니메이션 */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(63, 81, 181, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(63, 81, 181, 0); } 100% { box-shadow: 0 0 0 0 rgba(63, 81, 181, 0); } }
        .highlight-pulse { animation: pulse 1.5s; }
    </style>
</head>
<body>
    <div class="container">
        <!-- 사이드바 -->
        <div class="sidebar">
            <div class="header">
                <h1><i class="fa-solid fa-bug-slash"></i> Lovebug Map</h1>
                <p>Advanced AI Forecasting Dashboard</p>
            </div>

            <div class="dashboard-info">
                <div class="info-item"><span>데이터 기준일:</span><span id="current-date"></span></div>
                <div class="info-item"><span>현재 시각:</span><span id="current-time"></span></div>
                <div class="info-item"><span>예측 기간:</span><span>2025.07.17 ~ 2025.07.24</span></div>
                <div class="info-item"><span>마지막 업데이트:</span><span id="last-updated">방금 전</span></div>
            </div>

            <div class="hotspot-list">
                <h2><i class="fa-solid fa-triangle-exclamation"></i> 금주 Top 5 위험 지역</h2>
                <div id="hotspot-container"></div>
            </div>
        </div>

        <!-- 메인 컨텐츠 (지도) -->
        <div class="main-content">
            <div id="map"></div>
            
            <div class="map-controls">
                <!-- 다크 모드 토글 -->
                <div class="theme-switch-wrapper">
                    <i class="fa-solid fa-sun"></i>
                    <label class="theme-switch">
                        <input type="checkbox" id="theme-toggle">
                        <span class="slider"></span>
                    </label>
                    <i class="fa-solid fa-moon" style="margin-left: 8px; margin-right: 0;"></i>
                </div>
                <!-- 범례 패널 -->
                <div class="map-info-panel">
                    <h3>위험도 범례 (Heatmap)</h3>
                    <ul class="legend">
                        <li><i style="background: linear-gradient(to right, #43a047, #fdd835, #f57c00, #e53935);"></i> 낮음 → 위험</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- JS 라이브러리 -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- 0. 다크 모드 설정 ---
            const themeToggle = document.getElementById('theme-toggle');
            themeToggle.addEventListener('change', function() {
                if (this.checked) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                } else {
                    document.documentElement.setAttribute('data-theme', 'light');
                }
            });

            // --- 1. 시간 및 날짜 업데이트 ---
            const dateElement = document.getElementById('current-date');
            const timeElement = document.getElementById('current-time');
            const lastUpdatedElement = document.getElementById('last-updated');
            let lastUpdateTime = new Date();

            function updateTime() {
                const now = new Date();
                dateElement.textContent = now.toLocaleDateString('ko-KR');
                timeElement.textContent = now.toLocaleTimeString('ko-KR', { hour12: false });
                
                const secondsAgo = Math.floor((now - lastUpdateTime) / 1000);
                lastUpdatedElement.textContent = `${secondsAgo}초 전`;
            }
            updateTime();
            setInterval(updateTime, 1000);

            // --- 2. 지도 초기화 ---
            const map = L.map('map').setView([37.5665, 126.9780], 11);
            const lightTile = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '© CARTO' });
            const darkTile = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '© CARTO' });
            lightTile.addTo(map);

            themeToggle.addEventListener('change', () => {
                if (map.hasLayer(lightTile)) {
                    map.removeLayer(lightTile);
                    darkTile.addTo(map);
                } else {
                    map.removeLayer(darkTile);
                    lightTile.addTo(map);
                }
            });

            // --- 3. 가상 데이터 및 히트맵 생성 ---
            const dummyData = [
                { rank: 1, name: '은평구 진관동', score: 95, lat: 37.636, lng: 126.929, type: 'danger' },
                { rank: 2, name: '강서구 화곡동', score: 88, lat: 37.542, lng: 126.840, type: 'danger' },
                { rank: 3, name: '마포구 상암동', score: 82, lat: 37.577, lng: 126.892, type: 'danger' },
                { rank: 4, name: '서대문구 홍은동', score: 75, lat: 37.595, lng: 126.938, type: 'warning' },
                { rank: 5, name: '양천구 목동', score: 68, lat: 37.527, lng: 126.864, type: 'warning' },
            ];

            const heatData = dummyData.map(p => [p.lat, p.lng, p.score / 100]); // [lat, lng, intensity]
            const heatLayer = L.heatLayer(heatData, {
                radius: 25,
                blur: 15,
                maxZoom: 18,
                gradient: {0.4: 'blue', 0.6: 'lime', 0.8: 'yellow', 0.9: 'orange', 1: 'red'}
            }).addTo(map);

            // --- 4. 사이드바 Top 5 목록 및 인터랙션 ---
            const hotspotContainer = document.getElementById('hotspot-container');
            const highlightMarkers = {};

            function renderHotspots() {
                hotspotContainer.innerHTML = '';
                dummyData.filter(d => d.rank).sort((a,b) => a.rank - b.rank).forEach(item => {
                    const itemEl = document.createElement('div');
                    itemEl.className = `hotspot-item ${item.type}`;
                    itemEl.id = `item-${item.rank}`;
                    itemEl.innerHTML = `
                        <div class="item-header">
                            <span class="name">${item.name}</span>
                            <span class="rank">#${item.rank}</span>
                        </div>
                        <div class="item-details">위험도 지수: <span class="risk-score ${item.type}">${item.score}</span> 점</div>
                    `;
                    hotspotContainer.appendChild(itemEl);

                    const marker = L.circle([item.lat, item.lng], { radius: 10, stroke: false, fill: false }).addTo(map);
                    highlightMarkers[item.rank] = marker;

                    itemEl.addEventListener('click', () => map.setView([item.lat, item.lng], 14));
                    itemEl.addEventListener('mouseenter', () => {
                        marker.setStyle({ stroke: true, color: '#fff', weight: 3, fillColor: '#fff', fillOpacity: 0.5 });
                        marker.setRadius(2000);
                        marker.getElement().classList.add('highlight-pulse');
                    });
                    itemEl.addEventListener('mouseleave', () => {
                        marker.setStyle({ stroke: false });
                        marker.setRadius(10);
                        marker.getElement().classList.remove('highlight-pulse');
                    });
                });
            }
            renderHotspots();

            // --- 5. 실시간 데이터 업데이트 시뮬레이션 ---
            setInterval(() => {
                // 점수 약간 변경
                dummyData.forEach(d => {
                    d.score = Math.max(50, Math.min(100, d.score + (Math.random() - 0.5) * 5));
                });
                // 순위 재정렬
                dummyData.sort((a,b) => b.score - a.score).forEach((d,i) => d.rank = i + 1);
                
                // 히트맵 데이터 업데이트
                const newHeatData = dummyData.map(p => [p.lat, p.lng, p.score / 100]);
                heatLayer.setLatLngs(newHeatData);
                
                // 목록 다시 렌더링
                renderHotspots();
                
                lastUpdateTime = new Date(); // 마지막 업데이트 시간 갱신
            }, 5000); // 5초마다 업데이트
        });
    </script>
</body>
</html>
